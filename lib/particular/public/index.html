<html>
  <head>
    <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' rel='stylesheet' type='text/css'>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
  <script>
    var particle_03um = [];
    var particle_05um = [];

    $(function() {
      var arrayLength = 30;

      var dataArrays = {};

      var layout = {
	      yaxis: {
		      rangemode: 'tozero',
	      }
      }

      Plotly.plot('graph', [
	{
	  name: "PM1.0",
	  mode: 'lines',
	  line: {color: '#80CAF6', shape: 'spline'}
	},
	{
	  name: "PM2.5",
	  mode: 'lines',
	  line: {color: '#DF56F1', shape: 'spline'}
	},
	{
	  name: "PM10",
	  mode: 'lines',
	  line: {color: '#F1C356', shape: 'spline', title: 'asdf'}
	},
      ], layout);

      function appendToArray(arr, val) {
	      var newArr = arr.concat([val]);
	      newArr.splice(0, 1);
	      return newArr
      }

      var source = new EventSource('/samples');
      var timeParser = d3.timeParse("%Y-%m-%dT%H:%M:%S.%L%Z");
      source.onmessage = function(e) {
	      var data = JSON.parse(e.data);
	      data.time = timeParser(data.time);

	      for (var property in data) {
		if (dataArrays[property] == null) {
		  dataArrays[property] = new Array(arrayLength);
		}
		dataArrays[property] = appendToArray(dataArrays[property], data[property]);
	      }

	      var yArray = dataArrays.pm2_5_standard;
	      var xArray = dataArrays.time;

	      var data_update = {
		y: [dataArrays.pm1_0_standard, dataArrays.pm2_5_standard, dataArrays.pm10_standard],
		x: [xArray, xArray]
	      };

	      Plotly.update('graph', data_update);
      };
    });
  </script>
  <body>
    <div class="container">
      <h1 class="text-center">Particle Graph</h1>

      <div class="row">
        <div class="col-xs-12 text-center">
          <div id='graph'></div>
        </div>
      </div>
    </div>
  </body>
</html>
